<!DOCTYPE HTML>
<!--------------------------------------------------------------------------->  
<!--                           INTRODUCTION                                

 The CodeProject article submission template (HTML version)

Using this template will help us post your article sooner. To use, just 
follow the 3 easy steps below:
 
     1. Fill in the article description details
     2. Add links to your images and downloads
     3. Include the main article text

That's all there is to it! All formatting will be done by our submission
scripts and style sheets. 

-->  
<!--------------------------------------------------------------------------->  
<!--                        IGNORE THIS SECTION                            -->
<html>
<head>
<title>CodeProject</title>
<Style>
BODY, P, TD { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10pt }
H2,H3,H4,H5 { color: #ff9900; font-weight: bold; }
H2 { font-size: 13pt; }
H3 { font-size: 12pt; }
H4 { font-size: 10pt; color: black; }
PRE { BACKGROUND-COLOR: #FBEDBB; FONT-FAMILY: "Courier New", Courier, mono; WHITE-SPACE: pre; }
CODE { COLOR: #990000; FONT-FAMILY: "Courier New", Courier, mono; }
</style>

<link type="text/css" rel="stylesheet" 
      href="https://codeproject.global.ssl.fastly.net/App_Themes/CodeProject/Css/Main.min.css">
</head>
<body bgcolor="#FFFFFF" color=#000000>
    <!--------------------------------------------------------------------------->
    <!-------------------------------     STEP 1      --------------------------->
    <!--  Fill in the details (CodeProject will reformat this section for you) -->

<pre>
Title:       Enter Article Title Here
Author:      Enter your Code Project User Name (or suggest one if you're not a member)
Email:       Enter your Code Project E-mail Login (or the email you wish to use if not a member)
Language:    Enter the Languages that Apply to Your Article (C# 3.0, etc.)
Platform:    Enter the Platforms that Apply to Your Article (Windows, etc.)
Technology:  Enter the Technologies that Apply to Your Article (WPF, etc.)
Level:       Pick ONE: Beginner/Intermediate/Advanced
Description: Enter a brief description of your article
Section      Enter the Code Project Section you Wish the Article to Appear
SubSection   Enter the Code Project SubSection you Wish the Article to Appear
License:     Enter the license (<a href="http://www.codeproject.com/info/licenses.aspx">CPOL, CPL, MIT, etc</a>)
</pre>

<style>
table.mnist  {
  border: 1px solid blue;
  border-collapse: collapse;
}
table.mnist th
{
  border: 2px solid blue;
  border-collapse: collapse;

}
table.mnist tr
{
  border: 1px solid blue;
  border-collapse: collapse;
}
table.mnist td
{
  border: 1px solid blue;
  border-collapse: collapse;
  padding-left:5px;
  padding-right:5px
}
table.mnist td.header
{
  font-weight:bold;
}
table.mnist thead td
{
    font-weight:bold;
}
</style>

    <!-------------------------------     STEP 2      --------------------------->
    <!--  Include download and sample image information.                       -->

    <ul class=download>
        <li><a href="Article_demo.zip">Download demo project - XXX Kb </a></li>
        <li><a href="Article_src.zip">Download source - XXX Kb</a></li>
    </ul>

    <p>
        <img src="Article.gif" alt="Sample Image - maximum width is 600 pixels"
             style="width:400px; height:200px">
    </p>

    <!-------------------------------     STEP 3      --------------------------->
    <!--  Add the article text. Please use simple formatting (<h2>, <p> etc)   -->

    <h2 id="toc">Table of Contents</h2>
    <ul>
        <li>
            <a href="#intro">Introduction</a>
        </li>
        <li>
            <a href="#tensorflow">About Tensorflow</a>
        </li>
        <li>
            <a href="#back">Background</a>
        </li>
        <li>
            <a href="#mnist">What is MNIST? Why MNIST</a>
        </li>
        <li>
            <a href="#deeplearning">Deep learning</a>
            <ul>
                <li><a href="#deeplearning_perceptrons">Perceptrons</a></li>
                <li><a href="#deeplearning_singleperceptrons">Single perceptron</a></li>
                <li><a href="#deeplearning_multi_perceptrons">Multi layer perceptrons</a></li>
                <li><a href="#deeplearning_cnn">Convolutional Neural Networks</a></li>

            </ul>
        </li>
        <li>
            <a href="#tensorflowsharp">About TensorflowSharp</a>
        </li>
        <li>
            <a href="#tensorflowgpu">Using Tensorflow with GPU</a>
            <ul>
                <li><a href="#trainingusingpython_cnnarchitecture">CNN Archictecture</a></li>
                <li><a href="#trainingusingpython_loadimages">Loading training image files</a></li>
                <li><a href="#trainingusingpython_createmodel">Create CNN model</a></li>
                <li><a href="#trainingusingpython_trainmodel">Train the model and save model to file</a></li>
            </ul>
        </li>
        <li>
            <a href="#csharpconsole">Using Tensorflow in a C# console application</a>
            <ul>
                <li><a href="#csharpconsole_overview">Overview</a></li>
                <li><a href="#csharpconsole_create">Create a console application</a></li>
                <li><a href="#csharpconsole_loadmodel">Load the trained model file</a></li>
                <li><a href="#csharpconsole_evaluateimage">Load the test image and evaluate using TensorflowSharp</a></li>
                <li><a href="#csharpconsole_evaluateimage">Results</a></li>
                
            </ul>
        </li>
        <li>
            <a href="#usingthecode">Using the code</a>
            <ul>
                <li><a href="#usingthecode_github">Github</a></li>
                <li><a href="#usingthecode_structure">Solution structure</a></li>
                <li><a href="#usingthecode_pythontrainer">Python Trainer</a></li>
                <li><a href="#usingthecode_consoleapptester">ConsoleAppTester</a></li>
            </ul>
        </li>
        <li>
            <a href="#pointsofinterest">Points of interest</a>
        </li>
    </ul>

    <h2><a id="intro"></a>Introduction</h2>
    <p>In the field of pattern recognition, deep neural networks have gained prominence in the last 5 years. This can be largely attributed to availability of 
        cheaper hardware, programming libraries and labelled data. Deep neural networks or Convolutional neural networks (CNN) if trained properly 
        can give spectacular results. TensorFlow from Google is one the very popular libraries that implement some of these complicated algorithms</p>
    <p>
    In this article I am going to demonstrate how to train a CNN model to recognize handwritten digits from the MNIST database. This will be followed by a 
    C# console application which will consume the trained model to actually classiy the test images from the MNIST dataset. The objective of this article
        is to demonstrate how to make the best use of Python for training a model and .NET to build a hypothetical end user application which consumes the trained model.
    </p>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h2><a id="tensorflow"></a> About TensorFlow</h2>
    <h3>Tensorflow native library</h3>    
    <pre>
        ///
        ///https://www.tensorflow.org/install/lang_c
        ///The windows native implementation is downloadable as a single ZIP and structured as follows
        ///

        include
        --------
                |
                |
                |
                --c_api.h
                |
                |
        lib
        --------
                |
                |
                --tensorflow.dll
                |
                |
                --tensorflow.lib


    </pre>

    <h3>Tensorflow bindings for Python and C#</h3>
    <p>Tensorflow is implemented as C/C++ dynamic link library. Platform specific binaries are available in a ZIP file. Bindings in various languages are provided on top of this library. These are language specific wrappers which invoke the native libraries.
    Python is perhaps one of the most versatile programming layers built on top of the native TensorFlow implementations. TensorFlowSharp is the .NET wrapper over TensorFlow.
    </p>
    <pre>
                        TensorFlow(C/C++)
                        ----------------
                            |
                            |
        ------------------------------------------------
        |                                               |
        |                                               |
        |                                               |
      Python                                        TensorFlowSharp(C#)
      ------                                        -------------------
  (train model)                             (use model in client application)
    </pre>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h2 id="back">Background</h2>
    <ul>
        <li><strong>Python</strong> - I have used Python for training a CNN model using the MNIST dataset of handwritten digits. A basic knowlege of Python would be essential.
            I have used <strong>Visual Studio Code (1.36.1)</strong> for the Python scripts. You can use any Python editor that suits you.
        </li>
        <li>
            I have used <strong>Visual Studio 2017</strong> for the simple Console application which consumes the trained model and classifies the test images
        </li>
        <li>
            In this article I have used the <strong>GPU</strong> version of the Tensorflow for to improve the speed of learning. You would need  a <strong>GPU</strong> enabled desktop.
        The reader is cautioned that coding with the GPU requires additional <strong>CUDA</strong> libraries and drivers to be installed. This article also assumes that the reader
        is familiar with the basic principles of <strong>Deep Convolution Neural Networks</strong>.
        </li>
    </ul>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    

    <h2><a id="mnist"></a> What is MNIST? Why MNIST?</h2>
    <h3>Overview</h3>
    <p>MNIST database is a collection of handwritten digits (0-9). This comprises of 60,000 training and 10,000 testing images. Each of the images 
        is 28 pixels wide and 28 pixels high and all the images are in gray scale. 
        In the world of machine learning and computer vision, MNIST has become the de facto
        standard to test any new paradigm. (Reference <a href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a>)
        <img src="images/3_expanded.PNG" style="width:50%;height:50%;"/>
    </p>
    <h3>Example pictures</h3>
    <p>
        <img src="images/0.png"/>
        <img src="images/1.png"/>
        <img src="images/2.png"/>
        <img src="images/3.png"/>
        <img src="images/4.png"/>
        <img src="images/5.png"/>
        <img src="images/6.png"/>
        <img src="images/7.png"/>
        <img src="images/8.png"/>
        <img src="images/9.png"/>
    </p>
    <h3>Distribution of pictures</h3>
    <table class="mnist">
        <thead>
            <tr>
                <td></td>
                <td>0</td>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td>6</td>
                <td>7</td>
                <td>8</td>
                <td>9</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="header">Training</td>
                <td>5923</td>
                <td>6742</td>
                <td>5985</td>
                <td>6131</td>
                <td>5842</td>
                <td>5421</td>
                <td>5918</td>
                <td>6265</td>
                <td>5851</td>
                <td>5949</td>
            </tr>
            <tr>
                <td class="header">Testing</td>
                <td>980</td>
                <td>1135</td>
                <td>1032</td>
                <td>1010</td>
                <td>982</td>
                <td>892</td>
                <td>958</td>
                <td>1028</td>
                <td>974</td>
                <td>1009</td>

            </tr>
        </tbody>
    </table>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h2><a id="deeplearning"></a> Deep learning</h2>
    <h3 id="deeplearning_perceptrons">Perceptrons</h3>
    <p>
    In the 1940s and 50s the idea of a very basic mathematical neuron began to take shape. Researchers (McCulloch, Pitts and Rosenblatt) drew inspiration from the working of a biological neuron. Neurons are the building blocks of the nervous system. An average human brain has several billions of neurons indirectly connected to each other through synapses.
    They envisioned an individual neuron to behave like a straight-line classifier. The electric signals flowing in through the 
    dendrites represented a real-life signal (vector) and the output signal would represent a binary (on/off) state of classification. Frank Rosenblatt (1962) took the design of McCulloch and Pitts neuron a step forward by proposing the design of the linear perceptron in his book Principles of Neurodynamics (published 1962, Section “Completely linear perceptrons”). 
    </p>
    <img src="images/BioNeuron.PNG"/><br />
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h3 id="deeplearning_singleperceptrons">Single perceptron</h3>
    <img src="images/NeuronSingleNode.PNG"/>
    <p>The circle represents the equation of a straight line in the form of a.x+b.y+c=0. </p>
    <img src="images/Neuron_LinearClassifier.PNG" />
    <p>Given two classes of points X and O, which are linearly separable, you can find a straight line which divides the 2 classes. 
        If you feed in the coordinates of the points in class X to the equation a.x+b.y+c and then do the same for all points in class O
        then you are going to see that all points in class X produce a positive value , while all points in class O produce a negative value. 
        The change of sign could be other way round , depending on the constants a,b and c. Nevertheless, this is the overarching principle of a Perceptron.
    </p>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h3 id="deeplearning_multi_perceptrons">Multi layer perceptrons</h3>
    <img src="images/Neuron_XOR.PNG"/>
    <p>
    If we are unable to find a single line that separates the classes X and O , as in the case of the famous XOR problem, then we could 
    cascade multiple linear classifiers.
    </p>
    <img src="images/XOR_TruthTable.PNG"/>
    <br />
    <img src="images/MultiLayerPerceptron.PNG"/><br/>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h3 id="deeplearning_cnn">Convolutional Neural Networks</h3>
    <p>
        Deep learning takes neural networks forward by combining feature extraction and hyperplane discovery.
        The features are extracted by layers of filters. For a thorough treatise on this subject, the reader is requested to follow 
        Andrew Ng's tutorials.
    </p>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/ArPaAX_PhIs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    <br/>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    

    


    <h2><a id="tensorflowsharp"></a>TensorflowSharp - Using Tensorflow from a C# application</h2>
    <p>TODO Talk about Tensorflow</p>


    <h2 id="tensorflowgpu">Using Tensorflow with GPU</h2>
    <h3>Overview</h3>
    <pre>
                                Python script
                                --------------
                                        |
                                        |
                                        |

                              TensorFlow GPU package
                              ----------------------
                                        |
                                        |
                                        |
                                      cuDNN
                                      -----
                                        |
                                        |
                                        |
                                  CUDA Toolkit
                                  --------------
                                        |
                                        |
                                        |
                                     Drivers
                                     -------
                                        |
                                        |
                                        |
                                       GPU
                                       ---
                                
    </pre>
    <h3>What worked for me?</h3>
    <p>
        When using TensorFlow for training, you have the choice of using CPU and GPU. You will need the correct version of NVIDIA drivers
        and libraries. As a rule of thumb,the version of NVIDIA drivers should match the current version of TensorFlow. At the time of writing this article, I have used the python package TensorFlow-GPU 1.14.0.
        I would caution the reader that my experience with installing the drivers and getting TensorFlow GPU to work was less than smooth.
    </p>
    <ul>
        <li>
            Update the version of the NVIDIA drivers. I did not install the through NVIDIA web site. I updated the display adapter through the Windows Device Manager user interface.
            The version 24.21.14.1131  worked for me.

            <img src="images/DeviceManagerDisplayAdapter.png" style="border:1px solid gray"/>
        </li>
        <li>
            Install CUDA Toolkit 10.0 version
        <li>
            Install cuDNN SDK version 7.6.2 . I chose the Windows 10 edition. I copied over cudnn64_7.dll to %ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v10.0\bin
        </li>
        <li>
            Python package Tensorflow 1.14
        </li>
        <li>
            Python package Keras 2.2.4
        </li>
        <li>
            Python package Numpy 1.16.1
        </li>
    </ul>
    <a href="#toc" title="Back to Table of Contents">Top</a>

    <h2><a id="trainingusingpython"></a> Training a CNN model using TensorFlow and Python</h2>
    <h3 id="trainingusingpython_cnnarchitecture">CNN architecture</h3>
    <pre>
                                
                                 Input layer (28X28,1 channel)
                                 -----------------------------
                                            |
                                            |
                                            |           
                                 Convolution layer (5X5,20,RELU)
                                --------------------------------
                                            |
                                            |
                                            |           
                                Max Pool layer (2X2,stride=2)
                               ------------------------------
                                            |                              
                                            |                              
                                            |     
                                Convolution layer (5X5,50,RELU)
                               --------------------------------
                                            |                              
                                            |                              
                                            |                              
                                Max Pool layer (2X2,stride=2)
                                -----------------------------
                                            |                              
                                            |                              
                                            |     
                                         Flatten
                                        ---------
                                            |                              
                                            |                              
                                            |     
                                Dense layer (500 nodes,RELU)
                                ----------------------------
                                            |                              
                                            |                              
                                            |     
                                Dense layer (10 nodes,RELU)
                                ----------------------------
                                            |                              
                                            |                              
                                            |     
                                Output layer(Softmax)
                                ----------------------
    </pre>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h3 id="trainingusingpython_loadimages">Step 1 - Loading training image files</h3>
    <p>
        MNIST dataset can be readily accessed from the <a href="https://scikit-learn.org/stable/auto_examples/classification/plot_digits_classification.html">scikit-learn</a> package.
        However in this tutorial I have demonstrated how to load the images from disk. The individual PNG files are made available in the accompanying project MNISpng.csproj.        
        The python script MnistImageLoader.py will enumerated over the the directory structured and build a list of training/testing images. The parent folder of each PNG file will provide the 
        training label (0-9). 
    </p>
    <pre>
        MNIST
        -----
                |
                |
                training.zip
                -----------
                |    |
                |    |
                |    |--(folders 0 to 9)
                |           |
                |           |
                |           |_0
                |           |
                |           |
                |           |_1
                |           |
                |           |
                |           |_2
                |           .
                |           .
                |           ._9
                |
                |
                testing.zip
                -----------
                     |
                     |
                     |--(folders 0 to 9)
    </pre>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h3 id="trainingusingpython_loadimagesoython">Step 1 - Python script (MnistImageLoader.py)</h3>
    <pre>
    #
    #Load images and labels. Returns a tuple of image data,label
    #
    def load_images(path_in):
            filenames = glob.glob(path_in)
            images=[] 
            labels=[] #labels for each training file
            filenames = glob.glob(path_in)
            for filename in filenames:
                    #get the parent folder from the full path of the file /mnist/blah/training/3/34348.png
                    fulldir=os.path.dirname(filename)
                    parentfolder=os.path.basename(fulldir)
                    imagelabel=int(parentfolder)
                    labels.append(imagelabel)
                    img = get_im(filename)
                    images.append(img)
            return images,labels

    </pre>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    <h3 id="trainingusingpython_createmodel">Step 2 - Create CNN model</h3>
    <p>
        TODO Show python script
    </p>
    <a href="#toc" title="Back to Table of Contents">Top</a>

    <h3 id="trainingusingpython_trainmodel">Step 3 - Train model and save the model </h3>
    <p>
        TODO Show python script
    </p>
    <a href="#toc" title="Back to Table of Contents">Top</a>


    <h2 id="csharpconsole">C# console application</h2>
    <h3 id="csharpconsole_overview">Overview</h3>
    <pre>
        -----------------------
        1)Load trained model file
        -----------------------
                |
                |
        -----------------
        2)Load test images
        -----------------
                |
                |
        -----------------------------------
        3)Evaluate the test image using CNN
        -----------------------------------

    </pre>
    <h3 id="csharpconsole_create">Create a Console application</h3>
    <ul>
        <li>
            Create a new Console application using .NET Framework
        </li>
        <li>
            Add NUGET package reference to TensorflowSharp
        </li>
    </ul>
    <h3 id="csharpconsole_loadmodel">Load the trained model file</h3>
    <pre>
        TODO Show code snippet
    </pre>

    <h3 id="csharpconsole_evaluateimage">Load the test image and evaluate using TensorFlowSharp</h3>
    <pre>
        TODO Show code snippet
    </pre>
    <a href="#toc" title="Back to Table of Contents">Top</a>
    
    <h3 id="csharpconsole_results">Results</h3>
    <p>Display test vs epoch
        Display some pictures which failed
        Possibly confusion matrix
    </p>
    <a href="#toc" title="Back to Table of Contents">Top</a>

    <h2 id="usingthecode">Using the code</h2>
    <h3 id="usingthecode_github">Github Repository</h3>
    <a href="https://github.com/sdg002/MNISTpng">https://github.com/sdg002/MNISTpng</a>
    <h3 id="usingthecode_structure">Solution stucture</h3>
    <pre>
        Solution
        --------
                |
                |
                MNISTPng
                --------
                |
                |
                PythonTrainer
                -------------
                |
                |
                ConsoleAppTester
                ----------------

    </pre>

    <h3 id="usingthecode_pythontrainer">PythonTrainer</h3>
    <p>
        TODO Github

        A brief description of how to use the article or code. The class names, the
        methods and properties, any tricks or tips.
    </p>
    <p>Python scripts for training a CNN model</p>
    <h3 id="usingthecode_mnistpng">MNISTPng</h3>
    <p>to be done</p>
    <h3 id="usingthecode_consoleapptester">ConsoleAppTester</h3>
    <p>C# EXE which will use TensorFlowSharp to load the trained model</p>
    <a href="#toc" title="Back to Table of Contents">Top</a>
   

    <h2 id="pointsofinterest">Points of Interest</h2>

    <p>
        TODO Link to Andrew NG Youtube video

        Did you learn anything interesting/fun/annoying while writing the code? Did you do

        anything particularly clever or wild or zany?
    </p>
    <a href="#toc" title="Back to Table of Contents">Top</a>

    <h2>History</h2>

    <p>Keep a running update of any changes or improvements you've made here. </p>

    <!-------------------------------    That's it!   --------------------------->
</body>

</html>

